--- xmms2-0.2DrJekyll/src/plugins/avcodec/avcodec.c.orig	2007-05-20 17:55:40.000000000 +0200
+++ xmms2-0.2DrJekyll/src/plugins/avcodec/avcodec.c	2023-05-18 18:38:52.423864232 +0200
@@ -24,7 +24,7 @@
 #include <glib.h>
 
 #undef ABS
-#include "avcodec.h"
+#include <libavcodec/avcodec.h>
 
 #define AVCODEC_BUFFER_SIZE 16384
 
@@ -134,7 +134,7 @@ xmms_avcodec_init (xmms_xform_t *xform)
 		goto err;
 	}
 
-	if (codec->type != CODEC_TYPE_AUDIO) {
+	if (codec->type != AVMEDIA_TYPE_AUDIO) {
 		XMMS_DBG ("Codec '%s' found but its type is not audio", data->codec_id);
 		goto err;
 	}
@@ -155,9 +155,9 @@ xmms_avcodec_init (xmms_xform_t *xform)
 	data->codecctx->extradata_size = data->extradata_size;
 
 	/* FIXME: this is for ALAC but can be a different value */
-	data->codecctx->bits_per_sample = 16;
+	data->codecctx->bits_per_raw_sample = 16;
 
-	if (avcodec_open (data->codecctx, codec) < 0) {
+	if (avcodec_open2 (data->codecctx, codec, NULL) < 0) {
 		XMMS_DBG ("Opening decoder '%s' failed", codec->name);
 		goto err;
 	} else {
@@ -206,7 +206,6 @@ xmms_avcodec_read (xmms_xform_t *xform,
                    xmms_error_t *error)
 {
 	xmms_avcodec_data_t *data;
-	char outbuf[AVCODEC_MAX_AUDIO_FRAME_SIZE];
 	gint outbufsize, bytes_read = 0;
 	guint size;
 
@@ -215,6 +214,11 @@ xmms_avcodec_read (xmms_xform_t *xform,
 
 	size = MIN (data->outbuf->len, len);
 	while (size == 0) {
+		int got_frame = 0;
+		AVFrame *frame;
+		AVPacket packet;
+		av_init_packet (&packet);
+
 		if (data->buffer_length == 0) {
 			bytes_read = xmms_xform_read (xform,
 			                              (gchar *) data->buffer,
@@ -232,11 +236,19 @@ xmms_avcodec_read (xmms_xform_t *xform,
 			data->buffer_length += bytes_read;
 		}
 
-		bytes_read = avcodec_decode_audio (data->codecctx, (short *) outbuf,
-		                                   &outbufsize, data->buffer,
-		                                   data->buffer_length);
+		packet.data = data->buffer;
+		packet.size = data->buffer_length;
+
+		frame = av_frame_alloc();
+		if (frame == NULL) {
+			XMMS_DBG ("AVFrame allocation failed");
+			return -1;
+		}
+
+		bytes_read = avcodec_decode_audio4 (data->codecctx, frame, &got_frame, &packet);
 
 		if (bytes_read < 0) {
+			av_frame_free(&frame);
 			XMMS_DBG ("Error decoding data!");
 			return -1;
 		} else if (bytes_read == 0) {
@@ -246,9 +258,11 @@ xmms_avcodec_read (xmms_xform_t *xform,
 
 		data->buffer_length -= bytes_read;
 
-		if (outbufsize > 0) {
-			g_string_append_len (data->outbuf, outbuf, outbufsize);
+		if (got_frame) {
+			outbufsize = av_samples_get_buffer_size(NULL, data->codecctx->channels, frame->nb_samples, data->codecctx->sample_fmt, 1);
+			g_string_append_len (data->outbuf, frame->data[0], outbufsize);
 		}
+		av_frame_free(&frame);
 
 		size = MIN (data->outbuf->len, len);
 	}
